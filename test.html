<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Appointment Modal (FullCalendar)</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- FullCalendar -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

    <!-- SweetAlert2 for alerts/toasts -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* Smooth modal fade */
        #appointmentModal.show {
            display: flex;
            animation: fadeIn .15s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0
            }

            to {
                opacity: 1
            }
        }

        /* FullCalendar tweaks to match Tailwind look */
        .fc .fc-toolbar-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
        }

        .fc .fc-daygrid-day.fc-day-today {
            background: #ecfeff;
        }

        /* cyan-50 */
        .fc .fc-button-primary {
            background-color: #14b8a6;
            /* teal-500 */
            border: none;
        }

        .fc .fc-button-primary:hover {
            background-color: #0d9488;
        }

        /* teal-600 */
        .fc .fc-day-disabled,
        .fc .is-holiday {
            background-color: #fee2e2 !important;
            /* red-100 */
            cursor: not-allowed;
            position: relative;
        }

        .fc .is-holiday::after {
            content: "Holiday";
            position: absolute;
            right: 4px;
            bottom: 2px;
            font-size: 10px;
            color: #ef4444;
            /* red-500 */
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen">

    <!-- DEMO: Open Modal Button (remove if you already open the modal elsewhere) -->
    <div class="p-6">
        <button id="openModal" class="px-4 py-2 rounded bg-teal-500 text-white hover:bg-teal-600">Open Appointment
            Modal</button>
    </div>

    <!-- MODAL -->
    <div id="appointmentModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center hidden">
        <div class="bg-white rounded-lg w-full max-w-6xl mx-4 max-h-[90vh] overflow-hidden shadow-xl">
            <!-- Header -->
            <div class="p-6 border-b-4 border-teal-500 relative">
                <h3 class="text-2xl font-semibold text-gray-800 text-center">New Appointment</h3>
                <button id="closeModal"
                    class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-2xl leading-none">×</button>
            </div>

            <!-- Body -->
            <div class="p-6 grid grid-cols-1 lg:grid-cols-2 gap-6 overflow-y-auto max-h-[calc(90vh-96px)]">
                <!-- LEFT: Data fillers -->
                <form id="appointmentForm" class="space-y-5">
                    <div>
                        <label class="block text-sm text-gray-500 mb-1">Service</label>
                        <select id="service"
                            class="w-full px-4 py-3 rounded border border-gray-200 focus:border-teal-500 outline-none">
                            <option value="">Select service</option>
                            <option value="national-id">National ID Renewal</option>
                            <option value="passport">Passport Application</option>
                            <option value="driving-license">Driving License</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm text-gray-500 mb-1">Department</label>
                        <select id="department"
                            class="w-full px-4 py-3 rounded border border-gray-200 focus:border-teal-500 outline-none">
                            <option value="">Select department</option>
                            <option value="civil-registration">Civil Registration Department</option>
                            <option value="immigration">Immigration Department</option>
                            <option value="motor-traffic">Department of Motor Traffic</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm text-gray-500 mb-1">Branch</label>
                        <select id="branch"
                            class="w-full px-4 py-3 rounded border border-gray-200 focus:border-teal-500 outline-none">
                            <option value="">Select branch</option>
                            <option value="central">Central Government Office</option>
                            <option value="colombo">Colombo District Office</option>
                            <option value="kandy">Kandy District Office</option>
                        </select>
                    </div>

                    <div class="rounded-lg border border-gray-100 p-4 bg-gray-50">
                        <p class="text-sm text-gray-600">Selected Date:</p>
                        <p id="selectedDateText" class="text-lg font-semibold text-gray-800">—</p>
                        <p class="text-sm text-gray-600 mt-2">Selected Time:</p>
                        <p id="selectedTimeText" class="text-lg font-semibold text-gray-800">—</p>
                    </div>

                    <div class="text-center py-2">
                        <p class="text-lg text-gray-800">
                            Approx Queue Number: <span id="queueNumber" class="font-semibold">-</span>
                        </p>
                    </div>

                    <button type="submit" id="submitBtn" disabled
                        class="w-full bg-teal-500 disabled:opacity-50 disabled:cursor-not-allowed hover:bg-teal-600 text-white py-4 rounded font-semibold tracking-wider">
                        CREATE APPOINTMENT
                    </button>

                    <p class="text-center text-xs text-red-600 leading-relaxed">
                        Please Be Aware That Poya Days, Public Holidays, Bank Holidays, And Mercantile Holidays Are
                        Excluded.
                    </p>
                </form>

                <!-- RIGHT: Calendar + Time slots -->
                <div class="space-y-4">
                    <div id="calendar2" class="rounded-lg border border-gray-200 p-2 bg-white shadow-sm"></div>

                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="text-lg font-semibold text-gray-800">Available Time Slots</h4>
                            <div class="flex items-center gap-3 text-xs">
                                <span class="px-2 py-1 rounded bg-green-100">Available</span>
                                <span class="px-2 py-1 rounded bg-red-100">Unavailable</span>
                                <span class="px-2 py-1 rounded bg-sky-100">Selected</span>
                            </div>
                        </div>
                        <div id="timeSlots" class="grid grid-cols-2 md:grid-cols-3 gap-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // document.getElementById("openModal").addEventListener("click", () => {
        //   const modal = document.getElementById("appointmentModal");
        //   modal.classList.remove("hidden");
        //   modal.classList.add("flex"); // Make it flex so it centers
        // });

        // document.getElementById("closeModal").addEventListener("click", () => {
        //   const modal = document.getElementById("appointmentModal");
        //   modal.classList.add("hidden");
        //   modal.classList.remove("flex"); // Remove flex so it hides properly
        // });

        (() => {
            // ---------- CONFIG ----------
            // Add/modify holidays here (YYYY-MM-DD). Example includes common SL dates; extend as needed.
            const HOLIDAYS = new Set([
                "2025-01-14", // Poya
                "2025-02-04", // Independence Day
                "2025-04-13", "2025-04-14", // Sinhala & Tamil New Year
                "2025-05-01", // Labour Day
                "2025-05-12", // Example Poya
                "2025-06-11", // Example Poya
            ]);

            // Business hours (used for queue estimate & slot generation)
            const BASE_SLOTS = [
                "09:00-10:00",
                "10:00-11:00",
                "11:00-12:00",
                "14:00-15:00",
                "15:00-16:00",
            ];

            // Simulate per-date booked slots (replace with your API)
            // Key: 'YYYY-MM-DD' -> array of fully booked slots
            const BOOKED_BY_DATE = {
                // "2025-02-05": ["10:00-11:00", "15:00-16:00"],
            };

            // ---------- STATE ----------
            let selectedDate = null;  // "YYYY-MM-DD"
            let selectedSlot = null;  // "HH:mm-HH:mm"

            // ---------- DOM ----------
            const modal = document.getElementById('appointmentModal');
            const openBtn = document.getElementById('openModal');
            const closeBtn = document.getElementById('closeModal');
            const timeSlotsEl = document.getElementById('timeSlots');
            const selectedDateText = document.getElementById('selectedDateText');
            const selectedTimeText = document.getElementById('selectedTimeText');
            const queueNumberEl = document.getElementById('queueNumber');
            const form = document.getElementById('appointmentForm');
            const submitBtn = document.getElementById('submitBtn');

            // ---------- UTIL ----------
            const pad = n => String(n).padStart(2, '0');
            const toYMD = (d) => `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;

            function isHoliday(ymd) {
                return HOLIDAYS.has(ymd);
            }

            function isPast(ymd) {
                const today = new Date(); today.setHours(0, 0, 0, 0);
                const d = new Date(ymd); d.setHours(0, 0, 0, 0);
                return d < today;
            }

            // A stable pseudo-random hash for a string (for demo queue estimates)
            function hashStr(str) {
                let h = 2166136261 >>> 0;
                for (let i = 0; i < str.length; i++) {
                    h ^= str.charCodeAt(i);
                    h = Math.imul(h, 16777619);
                }
                return (h >>> 0);
            }

            function estimateQueue(ymd, slot) {
                if (!ymd || !slot) return "-";
                const h = hashStr(ymd + "|" + slot);
                return (h % 25) + 1; // 1..26
            }

            function toast(icon, title) {
                Swal.fire({
                    toast: true, position: 'top-end', showConfirmButton: false,
                    timer: 1800, timerProgressBar: true, icon, title
                });
            }

            function alertWarn(text) {
                Swal.fire({ icon: 'warning', title: 'Heads up', text });
            }

            function alertError(text) {
                Swal.fire({ icon: 'error', title: 'Missing details', text });
            }

            function alertSuccess(text) {
                Swal.fire({ icon: 'success', title: 'Appointment Created', text });
            }

            // ---------- TIME SLOTS RENDER ----------
            function renderTimeSlots(ymd) {
                timeSlotsEl.innerHTML = "";
                selectedSlot = null;
                selectedTimeText.textContent = "—";
                queueNumberEl.textContent = "-";
                submitBtn.disabled = true;

                if (!ymd) return;

                if (isHoliday(ymd)) {
                    timeSlotsEl.innerHTML = `<p class="text-sm text-red-600">No slots: holiday.</p>`;
                    return;
                }
                if (isPast(ymd)) {
                    timeSlotsEl.innerHTML = `<p class="text-sm text-gray-500">Past date.</p>`;
                    return;
                }

                const booked = new Set(BOOKED_BY_DATE[ymd] || []);

                // Demo rule: random extra unavailability to mimic load
                const randomUnavailableIdx = hashStr(ymd) % BASE_SLOTS.length;

                BASE_SLOTS.forEach((slot, idx) => {
                    const unavailable = booked.has(slot) || idx === randomUnavailableIdx;

                    const btn = document.createElement('button');
                    btn.type = "button";
                    btn.dataset.time = slot;
                    btn.className = [
                        "px-3 py-2 rounded border text-sm transition",
                        unavailable
                            ? "bg-red-100 text-gray-500 cursor-not-allowed border-red-200"
                            : "bg-green-100 hover:bg-green-200 border-green-200"
                    ].join(" ");
                    btn.textContent = slot.replace("-", " - ");

                    if (!unavailable) {
                        btn.addEventListener('click', () => {
                            // Unselect previous
                            [...timeSlotsEl.querySelectorAll('button')].forEach(b => {
                                b.classList.remove("ring-2", "ring-sky-400", "bg-sky-100");
                                if (!b.classList.contains("cursor-not-allowed")) {
                                    b.classList.remove("bg-green-200");
                                    b.classList.add("bg-green-100");
                                }
                            });
                            // Select this
                            btn.classList.add("ring-2", "ring-sky-400", "bg-sky-100");
                            selectedSlot = slot;
                            selectedTimeText.textContent = slot.replace("-", " - ");
                            queueNumberEl.textContent = estimateQueue(ymd, slot);
                            submitBtn.disabled = false;
                            toast('info', `Time selected: ${slot}`);
                        });
                    } else {
                        btn.disabled = true;
                    }

                    timeSlotsEl.appendChild(btn);
                });

                // If all unavailable
                const anyEnabled = !!timeSlotsEl.querySelector('button:not([disabled])');
                if (!anyEnabled) {
                    timeSlotsEl.innerHTML = `<p class="text-sm text-red-600">No available slots for ${ymd}.</p>`;
                    alertWarn("No available time slots for the selected date.");
                }
            }

            // ---------- CALENDAR ----------
            let calendar = null;

            function buildCalendar() {
                const calendarEl = document.getElementById('calendar2');

                calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    height: 520,
                    selectable: true,
                    weekends: true,
                    stickyHeaderDates: true,
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: ''
                    },
                    validRange: (nowDate) => ({ start: toYMD(new Date()) }),
                    dateClick: (info) => {
                        const ymd = info.dateStr;
                        if (isHoliday(ymd)) {
                            alertWarn("This date is a holiday. Please choose another date.");
                            selectedDate = null;
                            selectedDateText.textContent = "—";
                            renderTimeSlots(null);
                            return;
                        }
                        if (isPast(ymd)) return;

                        selectedDate = ymd;
                        selectedDateText.textContent = ymd;
                        toast('success', `Date selected: ${ymd}`);
                        renderTimeSlots(ymd);
                    },
                    // Shade holidays using background events
                    events: Array.from(HOLIDAYS).map(d => ({
                        start: d,
                        end: d,
                        display: 'background',
                        className: 'is-holiday'
                    })),
                    // Add a CSS class to day cells that are holidays to block pointer events
                    dayCellDidMount: (arg) => {
                        const ymd = toYMD(arg.date);
                        if (isHoliday(ymd)) {
                            arg.el.classList.add('is-holiday');
                        }
                    }
                });

                calendar.render();
            }

            // ---------- SUBMIT ----------
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                const service = document.getElementById('service').value.trim();
                const department = document.getElementById('department').value.trim();
                const branch = document.getElementById('branch').value.trim();

                if (!service || !department || !branch || !selectedDate || !selectedSlot) {
                    alertError("Please fill all fields and select date & time.");
                    return;
                }

                // TODO: Replace with real API call
                alertSuccess(`Your appointment is set for ${selectedDate} at ${selectedSlot}. Queue No: ${queueNumberEl.textContent}`);
                // Close modal after success (optional)
                setTimeout(() => hideModal(), 700);
            });

            // ---------- MODAL OPEN/CLOSE ----------
            function showModal() { modal.classList.add('show'); modal.classList.remove('hidden'); }
            function hideModal() { modal.classList.remove('show'); modal.classList.add('hidden'); }

            if (openBtn) openBtn.addEventListener('click', showModal);
            if (closeBtn) closeBtn.addEventListener('click', hideModal);
            modal.addEventListener('click', (e) => { if (e.target === modal) hideModal(); });

            // ---------- INIT ----------
            // Build calendar after modal is in DOM to ensure width calc is correct
            document.addEventListener('DOMContentLoaded', () => {
                buildCalendar();
                // Preselect "today" (if not holiday)
                const today = toYMD(new Date());
                if (!isHoliday(today)) {
                    selectedDate = today;
                    selectedDateText.textContent = today;
                    renderTimeSlots(today);
                }
            });

        })();
    </script>
</body>

</html>